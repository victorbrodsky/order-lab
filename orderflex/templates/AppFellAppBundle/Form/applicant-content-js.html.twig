{#
    Copyright 2017 Cornell University

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
#}

<script src='https://www.google.com/recaptcha/api.js' async defer></script>

<script language="Javascript">

//    let clickedButtonValue = null;
//    let formToSubmit = null;


    $(document).ready(function() {

        //showHideWell('.fellapp-ecfmgcertificate-field');
        //showHideWell('.fellapp-reprimand-field');
        //showHideWell('.fellapp-lawsuit-field');

        showHideWellByRadioButtons('.fellapp-ecfmgcertificate-field');
        showHideWellByRadioButtons('.fellapp-reprimand-field');
        showHideWellByRadioButtons('.fellapp-lawsuit-field');

        $('.textarea').bind('keydown keyup keypress cut copy past blur change', function(){
            copy_to_print_helper(this); // consider debouncing this to avoid slowdowns!
        });

        $('textarea').each(function(){
            copy_to_print_helper(this); // on initial page load
        });


        //console.log('cycle0=('+cycle+')');

        //Pre-set training period for which applying only for new form
        if( cycle == "new" ) {
            var now = new Date();
            $(".fellapp-startDate").datepicker().datepicker("setDate", new Date(now.getFullYear() + 2, 6, 1));
            $(".fellapp-endDate").datepicker().datepicker("setDate", new Date(now.getFullYear() + 3, 5, 30));
        }

        //add listener on rank change
        listenerFellAppRank(null);

        //$('[data-toggle="tooltip"]').tooltip();
        
        setUploadItineraryAndListener();

        $('#triggerDraft').on('click', function(e) {
            $('#btnSubmitHidden').val('fellapp-draft'); // Optional hidden field
            console.log('Click triggerDraft');
            e.preventDefault(); // prevent default form submission

            var submitterEmail = $('#oleg_fellappbundle_fellowshipapplication_user_infos_0_email').val();
            $('.submitterEmailDisplay').text(submitterEmail || '[no email provided]');
            console.log('submitterEmail='+submitterEmail);

            if (validateFellapp('draft')) {
                console.log('Click triggerDraft => show modal for draft');
                var userExists = userCheckExistUser(submitterEmail);
                if( userExists === true ) {
                    //user exists
                    console.log('draft user exists');
                    $('#confirmDraftUserExistModal').modal('show');
                } else if( userExists === false ) {
                    //user does not exist
                    console.log('draft user does not exist');
                    $('#confirmDraftModal').modal('show');
                } else {
                    alert("Unknown error in triggerDraft, email="+submitterEmail);
                }
//                $('#fellapp-applicant-form').submit(); // proceed with actual submission
            } else {
                console.log('Draft Validation failed.');
            }
        });

        $('#triggerSubmit').on('click', function(e) {
            //console.log('Click triggerSubmit 1');
            $('#btnSubmitHidden').val('fellapp-submit'); // Optional hidden field
            console.log('Click triggerSubmit');
            e.preventDefault(); // prevent default form submission

            var submitterEmail = $('#oleg_fellappbundle_fellowshipapplication_user_infos_0_email').val();
            $('.submitterEmailDisplay').text(submitterEmail || '[no email provided]');
            console.log('submitterEmail='+submitterEmail);

            //console.log('Click triggerSubmit 2');
            if (validateFellapp('active')) {
                console.log('Click triggerSubmit => show modal for submit');
                var userExists = userCheckExistUser(submitterEmail);
                if( userExists === true ) {
                    //user exists
                    console.log('submit user exists');
                    $('#confirmSubmitUserExistModal').modal('show');
                } else if( userExists === false ) {
                    //user does not exist
                    console.log('submit user does not exist');
                    $('#confirmSubmitModal').modal('show');
                } else {
                    alert("Unknown error triggerSubmit email="+submitterEmail);
                }
            } else {
                console.log('Submit Validation failed.');
            }
        });

        //triggerUpdate: no validation because submitted applications can not be edited, draft applications will be validated upon submition
        $('#triggerUpdate').on('click', function(e) {
            //console.log('Click triggerUpdate 1');
            $('#btnSubmitHidden').val('fellapp-update'); // Optional hidden field
            console.log('Click triggerUpdate');
            e.preventDefault(); // prevent default form submission
            $('#fellapp-applicant-form').submit();
        });

        //Modal's buttons
        //Submit application if user does not exist
        $('#submitSubmitBtn').on('click', function() {
            //console.log('Modal submit');
            //$('#confirmSubmitModal').fadeOut();
            $('#confirmSubmitModal').modal('hide');
            $('#fellapp-applicant-form').submit(); // proceed with actual submission
        });
        $('#cancelSubmitBtn').on('click', function() {
            //console.log('Modal cancel');
            //$('#confirmSubmitModal').fadeOut(); // just close modal
            $('#confirmSubmitModal').modal('hide');
        });
        //Submit application if user exists
        $('#submitSubmitUserExistBtn').on('click', function() {
            $('#confirmSubmitUserExistModal').modal('hide');
            $('#fellapp-applicant-form').submit(); // proceed with actual submission
        });
        $('#cancelSubmitUserExistBtn').on('click', function() {
            $('#confirmSubmitUserExistModal').modal('hide');
        });

        //Submit draft if user does not exist
        $('#submitDraftBtn').on('click', function() {
            $('#confirmDraftModal').modal('hide');
            $('#fellapp-applicant-form').submit(); // proceed with actual submission
        });
        $('#cancelDraftBtn').on('click', function() {
            $('#confirmDraftModal').modal('hide');
        });
        //Submit draft if user exists
        $('#submitDrafUserExistBtn').on('click', function() {
            $('#confirmDraftUserExistModal').modal('hide');
            $('#fellapp-applicant-form').submit(); // proceed with actual submission
        });
        $('#cancelDraftUserExistBtn').on('click', function() {
            $('#confirmDraftUserExistModal').modal('hide');
        });


    });


    function userCheckExistUser( submitterEmail ) {
        //var submitterEmail = $('#oleg_fellappbundle_fellowshipapplication_user_infos_0_email').val();
        var url = Routing.generate('employees_check_user_exist_email');
        var userExists = 'N/A';
        $.ajax({
            url: url,
            type: 'POST',
            data: { email: submitterEmail },
            async: false,
            success: function(response) {
                if (response === 'EXIST') {
                    console.log('User exists!');
                    // You can trigger any logic here
                    userExists = true;
                }
                if (response === 'DOESNOTEXIST') {
                    console.log('User does not exist.');
                    userExists = false;
                }
            },
            error: function ( x, t, m ) {
                console.log('AJAX error:', error);
                userExists = false;
            }
        });

        return userExists;
    }
//    async function checkExistUser_new() {
//        var submitterEmail = $('#oleg_fellappbundle_fellowshipapplication_user_infos_0_email').val();
//        var url = Routing.generate('employees_check_user_exist_email');
//
//        try {
//            const response = await $.ajax({
//                url: url,
//                type: 'POST',
//                data: { email: submitterEmail }
//            });
//            return response.exists === true;
//        } catch {
//            return false;
//        }
//    }



    //http://stackoverflow.com/questions/4435906/print-when-textarea-has-overflow
    function copy_to_print_helper(element){
        var print_helper = $(element).closest('.well').find('.print_helper');
        if( print_helper ) {
            print_helper.text($(element).val());
        }
    }

    function hideWell(element) {
        var delaytime = 500;
        if( cycle == 'download' ) {
            delaytime = 0;
        }
        $(element).closest('.form-element-holder').find('.wellcollapsable').hide(delaytime); //500
        $(element).closest('.form-element-holder').find('.wellcollapsable').find('input,textarea').val('');
        //resetUploadBtn($(element).closest('.form-element-holder').find('.wellcollapsable'));
    }

    function showWell(element) {
        var delaytime = 500;
        if( cycle == 'download' ) {
            delaytime = 0;
        }
        $(element).closest('.form-element-holder').find('.wellcollapsable').show(delaytime); //500
    }

    function showHideWell(element) {

        //console.log('showHideWell');

        if( $(element).is(':checked') ) {
            //console.log('checked');
            showWell(element);
        } else {
            //console.log('not checked');
            hideWell(element);
        }

        //listener
        $(element).click( function() {
            showHideWell(this);
        });
    }
    function showHideWellByRadioButtons_onchange(element) {
        console.log('showHideWellByRadioButtons');
        $(element).find('input:radio').on('change', function () {
            var checkedValue = $(this).val();
            console.log("checkedValue="+checkedValue);
            if (checkedValue == "0") {
                hideWell(element);
            }
            if (checkedValue == "1") {
                showWell(element);
            }
        });
    }
    function showHideWellByRadioButtons(element) {
        //console.log('showHideWellByRadioButtons');
        var checkedValue;
        $(element).find('input:radio').each(function() {
            if( $(this).is(':checked') ) {
                checkedValue = $(this).val();
                return false; // exit .each() loop early
            }
        });
        //console.log("checkedValue=",checkedValue);
        // Optional: act on the selected value
        if (checkedValue === '1') {
            showWell(element);
        }
        if (checkedValue === '0') {
            hideWell(element);
        }
    }




function validateFellapp( clickedButtonValue ) {

        console.log("Clicked button value:", clickedButtonValue);

        $('#error-box').hide();

        var error = null;

        //required: fellowshipSubspecialty
        var fellowshipSubspecialty = $('.fellapp-fellowshipSubspecialty').first().select2('val');
        //console.log('fellowshipSubspecialty=('+fellowshipSubspecialty+')');
        if (!error && !fellowshipSubspecialty) {
            error = "Please select the Fellowship Type before submitting";
        }

        //required: user-firstName
        var firstName = $('.user-firstName').first().val();
        if (!error && !firstName) {
            error = "Please fill in the First Name before submitting";
        }

        //required: user-lastName
        var lastName = $('.user-lastName').first().val();
        if (!error && !lastName) {
            error = "Please fill in the Last Name before submitting";
        }

        //required: user-email
        var email = $('.user-email').first().val();
        if (!error && !email) {
            error = "Please fill in your email address before submitting";
        }

        //We will have to create a new user for the draft submission,
        //therefore we will need minimum fields:
        //First Name, Last Name, E-Mail address, Phone number, Captcha answer, Fellowship Institution, Fellowship Department, Fellowship Specialty
        if( clickedButtonValue === 'draft' ) {
            if( error ) {
                $('#error-box').html(error);
                $('#error-box').show();
                return false;
            } else {
                return true;
            }
        }

        var startDate = $('.fellapp-startDate').first().val();
        //console.log('startDate=('+startDate+')');
        if (!error && !startDate) {
            error = "Please fill in the Start Date before submitting";
        }

        //required: user-firstName
        var endDate = $('.fellapp-endDate').first().val();
        if (!error && !endDate) {
            error = "Please fill in the Expected Graduation Date before submitting";
        }

        //required: user-email
        var email = $('.signature-name').first().val();
        if (!error && !email) {
            error = "Please sign the form by typing your first name and your last name into the ‘Signature’ field";
        }

        //required: user-email
        var email = $('.signature-date').first().val();
        if (!error && !email) {
            error = "Please enter today’s date into the ‘Date’ field next to the ‘Signature’ field.";
        }

        //console.log('error='+error);

        if( error ) {
            $('#error-box').html(error);
            $('#error-box').show();
            return false;
        }

        //All fields are ok, since we reach this point this is a submit button:
        //You are about to submit your application for review.
        // You will not have access to edit your application after it is submitted.
        // Are you sure you would like to submit your application?
        if( clickedButtonValue === 'active' ) {
            // Prevent default submission and show modal
            event.preventDefault();
            $('#confirmSubmitModal').modal('show');
            return false;
        }

        //$('#fellapp-applicant-form').submit();
        return true;
    }


    //disable upload itinerary if interview date is not set
    function setUploadItineraryAndListener() {
        
        if( cycle == 'show' ) {
            return;
        }
        
        var itineraryPanel = $('#Itinerary');
        var dropzone = itineraryPanel.find('.file-upload-dropzone');

        if( !dropzone || dropzone.length == 0 ) {
            return;
        }
        
        //make inactive if interview date is not set
        var dateField = itineraryPanel.find('.datepicker');
        var dateValue = dateField.val();
        //console.log('dateValue='+dateValue);
              
        setItineraryUploadFile( dropzone,dateValue );     
        
        //add listener to date field
        dateField.change(function() {
            //console.log( "new date=" + $(this).val() );
            setItineraryUploadFile( dropzone, $(this).val() );
        });
        
    }
    
    function setItineraryUploadFile( dropzone, dateValue ) {
        //console.log('set itinerary: dateValue='+dateValue);      
        
         var dropzoneDom = dropzone.get(0);
        //console.log('disable/enable dropzone className='+dropzoneDom.className);
        var myDropzone = dropzoneDom.dropzone;
        
        if( !dateValue ) {
            //console.log('in active dropzone');
            //disable
            dropzone.removeClass('dz-clickable'); // remove cursor
            if( myDropzone.listeners[1] ) {
                dropzoneDom.removeEventListener('click', myDropzone.listeners[1].events.click);   
            }
            
            dropzone.parent().tooltip({
                title: function() {
                    var titleText = "Please enter the interview date in order to upload the itinerary file";
                    return titleText;
                }
            });
            
        } else {
            //console.log('active dropzone');
            //enable
            dropzone.addClass('dz-clickable'); // add cursor
            dropzoneDom.addEventListener('click', myDropzone.listeners[1].events.click);
            dropzone.parent().tooltip('destroy');
        }
        
    }

//    function updateFellapp(fellappId) {
//
//        //first update report
//        //TODO: use messaging
//        updateFellAppReport(fellappId);
//
//        //submit form
//        $('#fellapp-applicant-form').submit();
//    }
//
//    //TODO: use messaging
//    function updateFellAppReport(fellappId) {
//        var url = Routing.generate('fellapp_update_report');
//
//        //var fellappId = $('#fellapp_id').val();
//        //console.log('fellappId='+fellappId);
//
//        $.ajax({
//            type: "POST",
//            url: url,
//            timeout: _ajaxTimeout,
//            async: true,
//            data: {id: fellappId}
//        }).success(function(data) {
//            //console.log('data='+data);
//        }).fail(function(data) {
//            console.log('fellapp update report failed: '+data);
//        });
//    }

</script>


